## 3. ProbeJを用いたデバッグ
ProbeJとは実行中のプログラムを観測するツールです．内部でJVMTIを用いており，JVMの起動時にエージェントとして指定することで利用できます．以下はProbeJを付加してJavaプログラムを実行する例です．
```bash
java -agentpath:lib/ProbeJ_ex.dll=options_none:39876 -cp bin jisd.demo.LoopN
```

ProbeJは以下のような特徴があります．
- 利用者が指定した情報だけを収集する
- 観測中にブレークポイントのセットやクリア,観測結果の取得が可能である
- プログラムの実行への影響を最小限にとどめる
- プログラムの実行を継続したまま（短時間の停止だけで）観測を行う

ProbeJを用いたときの最大の利点は**プログラムの実行への影響を最小限にとどめられる**ことです．
また，プログラムの実行を継続したまま観測を行うため，実行中のプログラムのデバッグに向いています．

現状ProbeJはWindowsのみで提供されており，その他のOSではProbeJを付加した起動は不可となっています．  
一方，Windows上でProbeJを付加して起動したプログラムを同一ホスト上またはその他のOSからデバッグすることは可能です．

3.ではProbeJを用いたデバッグについて説明します．

### 3.1 デバッガの起動と終了

ProbeJを用いたデバッグでは，デバッガを起動すると，必要ならばProbeJを付加して対象プログラムを起動し，その後,ProbeJとの通信が開始されます．**内部でProbeJを付加した対象プログラムを起動する場合**，JISDのメインスレッドは対象プログラムを起動し通信を開始するまでの間，**必ず1秒待機**します．なお1秒のうち0.8秒は対象プログラムの起動待機時間としてあらかじめ設定されています．なお，外部でProbeJを付加した対象プログラムを起動している場合は待機せず，直ちに通信が開始されます．

以下のようにDebuggerを生成します．


```java
var dbg = new Debugger("jisd.demo.HelloWorld", "-cp ../sample", true) // Windows only
```

または，


```java
var dbg = new Debugger("host.docker.internal", 39876, true) // Host: Windows only, Container: Windows or Linux
```

以下のコードによりデバッガを起動します．


```java
dbg.run(1000)
```

run()の引数には対象プログラムが観測ポイントに到達するまでの大まかな時間をミリ秒で指定します．上記の場合はrun()開始時から，(ProbeJとの通信開始までの待機時間1秒)+(ユーザ指定の1秒)=2秒後にメインスレッドが再開されます．

また，デバッグを終了する場合は以下を実行します．


```java
dbg.exit()
```

デバッグを終了するとProbeJとの通信が停止されますが，対象プログラムは終了しないことに注意してください．


### 3.2 観測ポイントの設定
JISDのProbeJを用いたデバッグでは，1種類の観測ポイントである**プルーブポイント**を提供します．

**プルーブポイント**が設定された場合，その観測ポイントに到達すると変数の値の観測のみを行い，最大100件がProbeJ側で保持されます．

ProbeJを用いたデバッグでは，どの変数に対して観測ポイントを設定するかを指定する必要があります．

具体的な設定方法を以下で説明します．

### 3.3 ProbePointの設定

3.1で作成したDebuggerインスタンス`dbg`に対して`jisd.demo.Subクラス`の`20行目`の`変数a`と`変数b`にプルーブポイントを設定したい場合は，以下のように設定することができます．


```java
String[] vars = {"a", "b"};
Optional<Point> pp = dbg.watch("jisd.demo.HelloWorld", 20, vars);
```

プルーブポイントはPointクラスを継承したProbePointクラスのインスタンスとして扱われます．また，ある行に重複して観測ポイントを設定することはできません．

プルーブポイントはブレークポイントやウォッチポイントとは異なり，後述のgetResults()を呼び出すまでDebugResultオブジェクトが生成されません．getResults()が呼び出されるまではProbeJが観測値を最大100件保持しています．

JPDAを用いたデバッグ同様，デフォルトクラス名が使用できます．(→2.5)
